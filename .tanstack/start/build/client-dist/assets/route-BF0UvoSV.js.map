{"version":3,"file":"route-BF0UvoSV.js","sources":["../../../../../src/routes/$seed/route.tsx?tsr-split=component"],"sourcesContent":["import {\n  createFileRoute,\n  Outlet,\n  redirect,\n  stripSearchParams,\n  Link,\n  useNavigate,\n} from '@tanstack/react-router';\nimport * as v from 'valibot';\nimport {\n  styleWithAutoValidator,\n  stepsWithAutoValidator,\n  angleWithAutoValidator,\n  DEFAULT_STEPS,\n  DEFAULT_STYLE,\n  DEFAULT_ANGLE,\n} from '~/validators';\nimport { observer, use$ } from '@legendapp/state/react';\nimport { uiTempStore$ } from '~/stores/ui';\nimport { useRef } from 'react';\nimport { AppHeader } from '~/components/header/AppHeader';\nimport { FooterSection } from '~/components/FooterSection';\nimport { deserializeCoeffs } from '~/lib/serialization';\nimport { SEARCH_DEFAULTS } from '../_layout';\nimport { StyleSelect } from '~/components/header/StyleSelect';\nimport { StepsInput } from '~/components/header/StepsInput';\nimport { AngleInput } from '~/components/header/AngleInput';\nimport { PrimaryDivider } from '~/components/Divider';\nimport type { Id } from '../../../convex/_generated/dataModel';\nimport type { AppCollection } from '~/types';\nimport { applyGlobals } from '~/lib/cosineGradient';\nimport { ArrowLeft } from 'lucide-react';\nimport { Button } from '~/components/ui/button';\nimport { cn } from '~/lib/utils';\nimport { ActionButton } from '~/components/header/ActionButton';\n\nexport const searchValidatorSchema = v.object({\n  style: v.optional(\n    v.fallback(styleWithAutoValidator, SEARCH_DEFAULTS.style),\n    SEARCH_DEFAULTS.style,\n  ),\n  steps: v.optional(\n    v.fallback(stepsWithAutoValidator, SEARCH_DEFAULTS.steps),\n    SEARCH_DEFAULTS.steps,\n  ),\n  angle: v.optional(\n    v.fallback(angleWithAutoValidator, SEARCH_DEFAULTS.angle),\n    SEARCH_DEFAULTS.angle,\n  ),\n});\n\nexport const Route = createFileRoute('/$seed')({\n  component: RouteComponent,\n  validateSearch: searchValidatorSchema,\n  search: {\n    middlewares: [stripSearchParams(SEARCH_DEFAULTS)],\n  },\n  headers: () => ({\n    // Browser: Cache for 30 minutes, allow stale for 1 hour\n    'cache-control': 'public, max-age=1800, stale-while-revalidate=3600',\n    // Cloudflare: Cache for 1 hour, stale-while-revalidate for 2 hours\n    'cdn-cache-control': 'max-age=3600, stale-while-revalidate=7200, durable',\n  }),\n  beforeLoad: async ({ params, search }) => {\n    const { seed } = params;\n\n    try {\n      // Try to deserialize the data - if it fails, redirect to home\n      const { coeffs, globals } = deserializeCoeffs(seed);\n      const processedCoeffs = applyGlobals(coeffs, globals);\n\n      // Create initial search data reference\n      const initialOptions = {\n        style: search.style === 'auto' ? DEFAULT_STYLE : search.style,\n        steps: search.steps === 'auto' ? DEFAULT_STEPS : search.steps,\n        angle: search.angle === 'auto' ? DEFAULT_ANGLE : search.angle,\n      };\n\n      // Create the seed collection object\n      const collection: AppCollection = {\n        coeffs,\n        globals,\n        style: initialOptions.style,\n        steps: initialOptions.steps,\n        angle: initialOptions.angle,\n        _id: seed as Id<'collections'>,\n        seed,\n        likes: 0,\n        _creationTime: Date.now(),\n      };\n\n      // Set the preview seed in the store\n      uiTempStore$.previewSeed.set(seed);\n\n      // Return the processed data to be merged into the route context\n      return {\n        seedData: {\n          coeffs,\n          globals,\n          processedCoeffs,\n          collection,\n          seed,\n        },\n      };\n    } catch (error) {\n      throw redirect({ to: '/', search });\n    }\n  },\n  onLeave: () => {\n    uiTempStore$.previewSeed.set(null);\n    uiTempStore$.activeCollectionId.set(null);\n    uiTempStore$.previewColorIndex.set(null);\n  },\n});\n\nfunction RouteComponent() {\n  return <Layout />;\n}\n\nconst Layout = observer(function Layout() {\n  const { style, steps, angle } = Route.useSearch();\n  const navigate = useNavigate({ from: '/$seed' });\n  const isDragging = use$(uiTempStore$.isDragging);\n  const navSelect = use$(uiTempStore$.navSelect);\n  const preferredOptions = use$(uiTempStore$.preferredOptions);\n  const initialSearchDataRef = useRef({\n    style: style === 'auto' ? DEFAULT_STYLE : style,\n    steps: steps === 'auto' ? DEFAULT_STEPS : steps,\n    angle: angle === 'auto' ? DEFAULT_ANGLE : angle,\n  });\n\n  const clearSearchParams = () => {\n    uiTempStore$.preferredOptions.set({\n      style: 'auto',\n      steps: 'auto',\n      angle: 'auto',\n    });\n    navigate({\n      search: (prev) => ({\n        ...prev,\n        ...initialSearchDataRef.current,\n      }),\n      replace: true,\n    });\n  };\n\n  const renderResetButton =\n    style !== initialSearchDataRef.current.style ||\n    steps !== initialSearchDataRef.current.steps ||\n    angle !== initialSearchDataRef.current.angle;\n\n  return (\n    <div\n      className={`min-h-screen scrollbar-stable ${isDragging ? 'overflow-hidden' : 'overflow-auto'}`}\n    >\n      <AppHeader className=\"sticky top-0 z-40 bg-background\" />\n\n      <PrimaryDivider className=\"absolute top-19 lg:top-22 z-50\" />\n\n      <main className=\"h-[calc(100vh-theme(spacing.16)-8px)] lg:h-[calc(100vh-theme(spacing.24)+8px)] min-h-[600px] relative flex flex-col\">\n        {/* Link Button that uses the navSelect state and lucid icon navSelect */}\n        <Link\n          to={navSelect}\n          search={(search) => {\n            return {\n              ...search,\n              ...preferredOptions,\n            };\n          }}\n          className=\"absolute top-4 lg:top-8 left-5 lg:left-14 z-10\"\n        >\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            aria-label=\"Go back\"\n            className={cn(\n              'justify-between',\n              'font-bold text-sm h-8.5 lg:h-10 px-3',\n              'border-input hover:border-muted-foreground/50 bg-background/80 hover:bg-background/90 backdrop-blur-sm disable-animation-on-theme-change text-muted-foreground hover:text-foreground transition-colors duration-200 cursor-pointer',\n            )}\n          >\n            <ArrowLeft className=\"h-4 w-4\" strokeWidth={2.5} />\n          </Button>\n        </Link>\n\n        <div className=\"flex items-center gap-3 absolute top-4 lg:top-8 right-5 lg:right-14 z-10\">\n          <div className=\"mr-2 relative\">\n            {renderResetButton && <ActionButton onClick={clearSearchParams}>reset</ActionButton>}\n          </div>\n\n          <StyleSelect\n            value={style}\n            className=\"w-[175px] lg:w-[190px] h-8.5 lg:h-10 bg-background/80 backdrop-blur-sm disable-animation-on-theme-change\"\n          />\n          <StepsInput\n            value={steps}\n            className=\"w-[90px] lg:w-[110px] h-8.5 lg:h-10 bg-background/80 backdrop-blur-sm disable-animation-on-theme-change\"\n          />\n          <AngleInput\n            value={angle}\n            className=\"w-[90px] lg:w-[110px] h-8.5 lg:h-10 bg-background/80 backdrop-blur-sm disable-animation-on-theme-change\"\n          />\n        </div>\n        <Outlet />\n      </main>\n      <FooterSection />\n    </div>\n  );\n});\n"],"names":["Layout","observer","style","steps","angle","Route","useSearch","navigate","useNavigate","from","isDragging","use$","uiTempStore$","navSelect","preferredOptions","initialSearchDataRef","useRef","DEFAULT_STYLE","DEFAULT_STEPS","DEFAULT_ANGLE","clearSearchParams","set","search","prev","current","replace","renderResetButton","jsx","AppHeader","PrimaryDivider","jsxs","Link","Button","cn","ArrowLeft","ActionButton","StyleSelect","StepsInput","AngleInput","Outlet","FooterSection","SplitComponent","$","_c","t0","Symbol","for"],"mappings":"0mBAuHA,MAAMA,EAASC,EAAS,UAAkB,CAClC,KAAA,CAAEC,MAAAA,EAAOC,MAAAA,EAAOC,MAAAA,CAAAA,EAAUC,EAAMC,UAAU,EAC1CC,EAAWC,EAAY,CAAEC,KAAM,QAAA,CAAU,EACzCC,EAAaC,EAAKC,EAAaF,UAAU,EACzCG,EAAYF,EAAKC,EAAaC,SAAS,EACvCC,EAAmBH,EAAKC,EAAaE,gBAAgB,EACrDC,EAAuBC,EAAAA,OAAO,CAClCd,MAAOA,IAAU,OAASe,EAAgBf,EAC1CC,MAAOA,IAAU,OAASe,EAAgBf,EAC1CC,MAAOA,IAAU,OAASe,EAAgBf,CAAAA,CAC3C,EAEKgB,EAAoBA,IAAM,CAC9BR,EAAaE,iBAAiBO,IAAI,CAChCnB,MAAO,OACPC,MAAO,OACPC,MAAO,MAAA,CACR,EACQG,EAAA,CACPe,OAAmBC,IAAA,CACjB,GAAGA,EACH,GAAGR,EAAqBS,OAAAA,GAE1BC,QAAS,EAAA,CACV,CACH,EAEMC,EACJxB,IAAUa,EAAqBS,QAAQtB,OACvCC,IAAUY,EAAqBS,QAAQrB,OACvCC,IAAUW,EAAqBS,QAAQpB,MAEzC,cACG,MACC,CAAA,UAAW,iCAAiCM,EAAa,kBAAoB,eAAe,GAE5F,SAAA,CAACiB,EAAAA,IAAAC,EAAA,CAAU,UAAU,iCAAiC,CAAA,EAEtDD,EAAAA,IAACE,EAAe,CAAA,UAAU,gCAAgC,CAAA,EAE1DC,EAAAA,KAAC,OAAK,CAAA,UAAU,sHAEd,SAAA,CAAAH,EAAA,IAACI,EACC,CAAA,GAAIlB,EACJ,OAAoBS,IACX,CACL,GAAGA,EACH,GAAGR,CACL,GAEF,UAAU,iDAEV,SAACa,EAAAA,IAAAK,EAAA,CACC,QAAQ,UACR,KAAK,KACL,aAAW,UACX,UAAWC,EACT,kBACA,uCACA,oOACF,EAEA,SAACN,EAAA,IAAAO,EAAA,CAAU,UAAU,UAAU,YAAa,GAAI,CAAA,CAAA,CAClD,CACF,CAAA,EAEAJ,EAAAA,KAAC,MAAI,CAAA,UAAU,2EACb,SAAA,CAACH,EAAA,IAAA,MAAA,CAAI,UAAU,gBACZD,SAAAA,SAAsBS,EAAa,CAAA,QAASf,EAAmB,SAAA,OAAA,CAAK,CACvE,CAAA,EAECO,EAAA,IAAAS,EAAA,CACC,MAAOlC,EACP,UAAU,2GAA0G,EAErHyB,EAAA,IAAAU,EAAA,CACC,MAAOlC,EACP,UAAU,0GAAyG,EAEpHwB,EAAA,IAAAW,EAAA,CACC,MAAOlC,EACP,UAAU,yGAAyG,CAAA,CAAA,EAEvH,QACCmC,EAAM,CAAA,CAAA,CAAA,EACT,QACCC,EAAa,CAAA,CAAA,CAAA,EAChB,CAEJ,CAAC,EAAEC,EAAA,UAAA,CAAAC,MAAAA,EAAAC,IAAA,CAAA,EAAAC,IAAAA,EAAA,OAAAF,EAAA,CAAA,IAAAG,OAAAC,IAAA,2BAAA,GA5FMF,QAAC5C,EAAS,EAAA,EAAA0C,KAAAE,GAAAA,EAAAF,EAAA,CAAA,EAAVE,CAAU"}